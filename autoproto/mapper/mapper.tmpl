{{ define "mapper" }}
func {{ .FuncName }}(source *{{ .SourcePkgName }}.{{ .SourceName }}, modifier ...func(source *{{ .SourcePkgName }}.{{ .SourceName }}, target *{{ .TargetPkgName }}.{{ .TargetName }}) error) (*{{ .TargetPkgName }}.{{ .TargetName }}, error) {
	if source == nil {
		return nil, fmt.Errorf("entproto: nil {{ .SourceName }} entity")
	}
	target := &{{ .TargetPkgName }}.{{ .TargetName }}{}
{{- range .Fields }}
{{- if .GuardExpr }}
	if {{ .GuardExpr }} {
		target.{{ .TargetField }} = {{ .ValueExpr }}
	}
{{- else }}
	target.{{ .TargetField }} = {{ .ValueExpr }}
{{- end }}
{{- end }}
	for _, m := range modifier {
		if err := m(source, target); err != nil {
			return nil, err
		}
	}
	return target, nil
}

func {{ .ListFuncName }}(sources []*{{ .SourcePkgName }}.{{ .SourceName }}, modifier ...func(source *{{ .SourcePkgName }}.{{ .SourceName }}, target *{{ .TargetPkgName }}.{{ .TargetName }}) error) ([]*{{ .TargetPkgName }}.{{ .TargetName }}, error) {
	if len(sources) == 0 {
		return nil, nil
	}
	out := make([]*{{ .TargetPkgName }}.{{ .TargetName }}, 0, len(sources))
	for _, item := range sources {
		if item == nil {
			continue
		}
		res, err := {{ .FuncName }}(item, modifier...)
		if err != nil {
			return nil, fmt.Errorf("entproto: convert {{ .SourceName }} list: %w", err)
		}
		out = append(out, res)
	}
	return out, nil
}
{{ end }}
